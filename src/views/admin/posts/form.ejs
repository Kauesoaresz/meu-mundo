<h2 class="admin-title">
  <%= post ? "‚úèÔ∏è Editar Post" : "‚ûï Novo Post" %>
</h2>

<form
  class="admin-form"
  method="POST"
  enctype="multipart/form-data"
  action="<%= post ? `/admin/posts/${post.id}/editar` : '/admin/posts' %>"
>

  <div class="admin-grid">

    <!-- =========================
         COLUNA ESQUERDA ‚Äî CONTE√öDO
    ========================== -->
    <div>

      <div class="admin-section">
        <h3>Conte√∫do</h3>

        <label>T√≠tulo</label>
        <input type="text" name="titulo" value="<%= post?.titulo || "" %>" required>

        <label>Descri√ß√£o curta</label>
        <input type="text" name="descricao" value="<%= post?.descricao || "" %>" required>

        <label>Conte√∫do</label>
        <textarea name="conteudo" rows="10" required><%= post?.conteudo || "" %></textarea>
      </div>

      <div class="admin-section">
        <h3>V√≠deo</h3>
        <label>V√≠deo do YouTube</label>
        <input type="text" name="video_youtube" value="<%= post?.video_youtube || "" %>">
      </div>

      <div class="admin-section">
        <h3>üìç Coordenadas</h3>

        <div class="admin-grid">
          <input type="number" name="coord_x" placeholder="X" value="<%= post?.coord_x || "" %>">
          <input type="number" name="coord_y" placeholder="Y" value="<%= post?.coord_y || "" %>">
          <input type="number" name="coord_z" placeholder="Z" value="<%= post?.coord_z || "" %>">
        </div>

        <select name="dimensao">
          <option value="">Dimens√£o</option>
          <option value="overworld" <%= post?.dimensao === "overworld" ? "selected" : "" %>>Overworld</option>
          <option value="nether" <%= post?.dimensao === "nether" ? "selected" : "" %>>Nether</option>
          <option value="end" <%= post?.dimensao === "end" ? "selected" : "" %>>End</option>
        </select>
      </div>

    </div>

    <!-- =========================
         COLUNA DIREITA ‚Äî CONTROLE
    ========================== -->
    <div>

      <div class="admin-section">
        <h3>Organiza√ß√£o</h3>

        <label>Se√ß√£o</label>
        <select name="secao_id" required>
          <% secoes.forEach(secao => { %>
            <option value="<%= secao.id %>" <%= post?.secao_id === secao.id ? "selected" : "" %>>
              <%= secao.nome %>
            </option>
          <% }) %>
        </select>
      </div>

      <!-- IMAGEM DE CAPA -->
      <div class="admin-section">
        <h3>Imagem de Capa</h3>

        <label>Imagem (URL)</label>
        <input
          type="text"
          name="imagem"
          id="imagemUrl"
          value="<%= post?.imagem || "" %>"
        >

        <label>Imagem (Upload)</label>
        <input
          type="file"
          name="imagem_upload"
          id="imagemUpload"
          accept="image/*"
        >

        <div id="previewCapa" style="margin-top: 10px;">
          <% if (post?.imagem) { %>
            <img
              src="<%= post.imagem %>"
              style="width:100%; border-radius:10px;"
            >
          <% } %>
        </div>

        <small style="color: var(--muted);">
          Upload tem prioridade sobre URL
        </small>
      </div>

      <!-- GALERIA -->
     <div class="admin-section">
  <h3>Galeria</h3>

  <input
    type="file"
    name="galeria"
    id="galeriaInput"
    accept="image/*"
    multiple
  >

  <div
    id="previewGaleria"
    style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;"
  ></div>

  <% if (post?.imagens?.length) { %>
    <hr style="margin:15px 0; border-color:#2a2a2a;">
    <h4 style="margin-bottom:10px;">Imagens j√° salvas</h4>

    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;">
      <% post.imagens
  .filter(img => img.imagem !== post.imagem)
  .forEach(img => { %>

        <div style="position:relative;">
          <img
            src="<%= img.imagem %>"
            style="width:100%; border-radius:8px;"
          >

          <form
            method="POST"
            action="/admin/posts/imagem/<%= img.id %>/excluir"
            onsubmit="return confirm('Remover esta imagem?')"
            style="position:absolute; top:5px; right:5px;"
          >
            <button
              type="submit"
              class="btn btn-danger"
              style="padding:4px 6px; font-size:10px;"
            >
              ‚úï
            </button>
          </form>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>


      <!-- A√á√ïES -->
      <div class="admin-section">
        <h3>A√ß√µes</h3>

        <div class="admin-actions">
          <button class="btn btn-primary">Salvar</button>
          <a href="/admin/posts" class="btn">Cancelar</a>
        </div>
      </div>

    </div>

  </div>

</form>

<script>
  // Preview imagem por URL
  const urlInput = document.getElementById("imagemUrl");
  const uploadInput = document.getElementById("imagemUpload");
  const preview = document.getElementById("previewCapa");

  if (urlInput) {
    urlInput.addEventListener("input", () => {
      if (urlInput.value) {
        preview.innerHTML = `<img src="${urlInput.value}" style="width:100%; border-radius:10px;">`;
      }
    });
  }

  // Preview imagem por upload
  if (uploadInput) {
    uploadInput.addEventListener("change", () => {
      const file = uploadInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.innerHTML = `<img src="${e.target.result}" style="width:100%; border-radius:10px;">`;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  
</script>

<script>
  const galeriaInput = document.getElementById("galeriaInput");
  const previewGaleria = document.getElementById("previewGaleria");

  if (galeriaInput) {
    galeriaInput.addEventListener("change", () => {
      previewGaleria.innerHTML = "";

      Array.from(galeriaInput.files).forEach(file => {
        const reader = new FileReader();

        reader.onload = e => {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.style.width = "100%";
          img.style.borderRadius = "8px";
          previewGaleria.appendChild(img);
        };

        reader.readAsDataURL(file);
      });
    });
  }
</script>
